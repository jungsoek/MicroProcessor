# 11. μ΄μμ²΄μ  μ—°λ™

## 11.1 ν”„λ΅μ„Έμ„μ™€ μ΄μμ²΄μ  κ°„ κ΄€κ³„

> ν•λ“μ›¨μ–΄μ β€ν•µμ‹¬β€™κ³Ό μ†ν”„νΈμ›¨μ–΄μ β€κ΄€λ¦¬μβ€™ κ°„ ν‘λ ¥ κµ¬μ΅°

### π§  κ°λ… μ”μ•½

| μ»΄ν¬λ„νΈ          | μ„¤λ…                                   |
| ----------------- | -------------------------------------- |
| **ν”„λ΅μ„Έμ„(CPU)** | λ…λ Ήμ–΄ μ‹¤ν–‰, μ—°μ‚°, μ μ–΄ μ‹ νΈ μƒμ„±      |
| **μ΄μμ²΄μ (OS)**  | μμ› κ΄€λ¦¬, ν”„λ΅μ„Έμ¤/λ©”λ¨λ¦¬/μ…μ¶λ ¥ μ μ–΄ |

> CPUλ” μΌμ„ "μν–‰"ν•λ” μ¥μΉ,
>  OSλ” "μ–΄λ–¤ μΌμ΄ μ–Έμ , μ–΄λ–»κ² μν–‰λ μ§€"λ¥Ό κ²°μ •ν•λ” **μ¤‘μ¬μ**

### π”„ λ‘ μ‹μ¤ν…μ μƒνΈ μ‘μ© κµ¬μ΅°

```
[ μ‚¬μ©μ ν”„λ΅κ·Έλ¨ ]
       β†“ μ‹μ¤ν… μ½
[ μ΄μμ²΄μ  (μ»¤λ„ λ¨λ“) ]
       β†“ μΈν„°λ½νΈ μ μ–΄ / μμ› μ¤μΌ€μ¤„λ§
[ ν•λ“μ›¨μ–΄ (CPU, λ©”λ¨λ¦¬, I/O) ]
```

#### μ£Όμ” ν‚¤μ›λ“:

- **μ‹μ¤ν… μ½ (System Call)**: μ‚¬μ©μ ν”„λ΅κ·Έλ¨μ΄ OS κΈ°λ¥μ„ μ”μ²­ν•λ” μΈν„°νμ΄μ¤
- **μΈν„°λ½νΈ (Interrupt)**: ν•λ“μ›¨μ–΄ μ΄λ²¤νΈκ°€ CPUμ—κ² μ‹ νΈλ¥Ό λ³΄λ‚΄λ” λ°©μ‹
- **μ»¨ν…μ¤νΈ μ¤μ„μΉ­ (Context Switch)**: ν”„λ΅μ„Έμ„ μƒνƒλ¥Ό λ‹¤λ¥Έ ν”„λ΅μ„Έμ¤λ΅ κµμ²΄

### π“¦ CPUκ°€ OSμ— μ κ³µν•λ” κΈ°λ¥

| κΈ°λ¥                         | μ„¤λ…                                                         |
| ---------------------------- | ------------------------------------------------------------ |
| **νΉκ¶ λ…λ Ή μ§€μ›**           | μ»¤λ„ λ¨λ“μ—μ„λ§ μ‹¤ν–‰ κ°€λ¥ν• λ…λ Ήμ–΄ μ κ³µ (ex. I/O μ μ–΄, MMU μ„¤μ • λ“±) |
| **μΈν„°λ½νΈ λ©”μ»¤λ‹μ¦**        | ν•λ“μ›¨μ–΄ μ΄λ²¤νΈλ¥Ό OSκ°€ κ°μ§€ν•κ³  μ²λ¦¬ν•  μ μλ„λ΅ μ§€μ›        |
| **μ‹μ¤ν… μ½ μΈν„°νμ΄μ¤**     | μ‚¬μ©μ μ½”λ“μ—μ„ μ»¤λ„λ΅ μ•μ „ν•κ² μ§„μ…ν•  μ μλ” μλ‹¨          |
| **λ¨λ“ μ „ν™(User β†” Kernel)** | CPUκ°€ λ¨λ“ λΉ„νΈλ¥Ό λ°”κΎΈμ–΄ OS λ³΄νΈ                             |
| **λ©”λ¨λ¦¬ λ³΄νΈ(MMU)**         | μ£Όμ† κ³µκ°„μ„ λ¶„λ¦¬ν•μ—¬ λ‹¤μ¤‘ ν”„λ΅μ„Έμ¤ μ¶©λ λ°©μ§€                 |
| **νƒ€μ΄λ¨Έ μΈν„°λ½νΈ**          | μ‹λ¶„ν•  μ΄μμ²΄μ  κµ¬ν„μ— ν•„μ”ν• μ •κΈ° μΈν„°λ½νΈ μ κ³µ             |

### π› οΈ ν•λ“μ›¨μ–΄ μ¶”μƒν™” κ³„μΈµ (HAL: Hardware Abstraction Layer)

μ΄μμ²΄μ λ” CPUμ μ„Έλ¶€μ μΈ λ μ§€μ¤ν„° κµ¬μ΅°λ‚ λ…λ Ήμ–΄ μ§‘ν•©μ„ **μ§μ ‘ μ‚¬μ©ν•λ” λ€μ‹ **,
 **μΌκ΄€λ μΈν„°νμ΄μ¤(HAL)λ¥Ό ν†µν•΄ λ‹¤μ–‘ν• CPUλ¥Ό μ§€μ›**ν•κ² λΌ.

| μμ‹                   | μ„¤λ…                                         |
| ---------------------- | -------------------------------------------- |
| `x86`, `ARM`, `RISC-V` | μ„λ΅ λ‹¤λ¥Έ κµ¬μ΅°μ§€λ§ κ³µν†µλ OS μΈν„°νμ΄μ¤ μ κ³µ |
| HAL κΈ°λ¥               | νƒ€μ΄λ¨Έ μ„¤μ •, μΈν„°λ½νΈ λ“±λ΅, μΊμ‹ μ μ–΄ λ“±     |

### π” μ‹μ¤ν… μ½ μ²λ¦¬ νλ¦„

```
[1] μ‚¬μ©μ ν”„λ΅κ·Έλ¨μ—μ„ system call λ°μƒ  
[2] CPU β†’ νΉμ λ…λ Ήμ–΄ (μ: `int 0x80`, `ecall`)  
[3] ν•λ“μ›¨μ–΄κ°€ λ¨λ“λ¥Ό User β†’ Kernelλ΅ μ „ν™  
[4] OS μ»¤λ„μ μ‹μ¤ν… μ½ ν•Έλ“¤λ¬λ΅ μ§„μ…  
[5] OSκ°€ μ”μ²­μ„ μ²λ¦¬ν•κ³  κ²°κ³Ό λ°ν™  
[6] λ‹¤μ‹ User λ¨λ“λ΅ λ³µκ·€
```

> μ΄λ” ν•λ“μ›¨μ–΄μ **νΈλ©(Trap)** λλ” **μ†ν”„νΈμ›¨μ–΄ μΈν„°λ½νΈ**λ΅ κµ¬ν„λ¨.

### π§© μΈν„°λ½νΈμ™€ OSμ μ—­ν• 

| μΈν„°λ½νΈ μΆ…λ¥           | μμ‹                     | OSμ—μ„ ν•λ” μΌ                                     |
| ----------------------- | ------------------------ | -------------------------------------------------- |
| **ν•λ“μ›¨μ–΄ μΈν„°λ½νΈ**   | νƒ€μ΄λ¨Έ, ν‚¤λ³΄λ“, λ„¤νΈμ›ν¬ | μ¥μΉ λ“λΌμ΄λ²„ νΈμ¶, μΈν„°λ½νΈ μ„λΉ„μ¤ λ£¨ν‹΄(ISR) μ‹¤ν–‰ |
| **μ†ν”„νΈμ›¨μ–΄ μΈν„°λ½νΈ** | μ‹μ¤ν… μ½                | μ‚¬μ©μ β†’ μ»¤λ„ μ§„μ…                                 |

β†’ CPUλ” μΈν„°λ½νΈ λ²΅ν„° ν…μ΄λΈ”μ„ ν†µν•΄ κ° μΈν„°λ½νΈμ— λ§λ” **OS λ£¨ν‹΄μΌλ΅ μ ν”„**ν•¨

### π” λ³΄νΈ λ©”μ»¤λ‹μ¦: λ¨λ“ μ „ν™ λ° MMU

#### β… λ¨λ“ μ „ν™ (User β†” Kernel Mode)

- User λ¨λ“μ—μ„λ” **I/O, MMU μ„¤μ • λ“±μ μ„ν—ν• λ…λ Ή κΈμ§€**
- μ‹μ¤ν… μ½μ΄λ‚ μΈν„°λ½νΈλ΅λ§ μ»¤λ„ μ§„μ… ν—μ©
- μ»¤λ„ λ¨λ“μ—μ„λ§ μ „μ²΄ μμ› μ ‘κ·Ό κ°€λ¥

#### β… MMU (Memory Management Unit)

- μ΄μμ²΄μ κ°€ νμ΄μ§€ ν…μ΄λΈ”μ„ μ„¤μ •ν•κ³ ,
   **CPUκ°€ μ΄λ¥Ό κΈ°λ°μΌλ΅ κ°€μƒ μ£Όμ† β†’ λ¬Όλ¦¬ μ£Όμ† λ³€ν™**

> κ²°κ³Όμ μΌλ΅ CPUλ” **OSκ°€ μ •μν• λ©”λ¨λ¦¬ κ²½κ³„ λ‚΄μ—μ„λ§ μ‹¤ν–‰** κ°€λ¥

### π“ μ‹¤μ  κµ¬μ΅° μμ‹: λ¦¬λ…μ¤ + ARM Cortex-A

| κµ¬μ„± μ”μ†                  | μ—­ν•                                         |
| -------------------------- | ------------------------------------------- |
| **SVC #0**                 | μ‹μ¤ν… μ½ νΈλ© λ…λ Ή                         |
| **Exception Vector Table** | ARMμ μΈν„°λ½νΈ λ²΅ν„°                         |
| **CPSR λ¨λ“ λΉ„νΈ**         | ν„μ¬ λ¨λ“ (User / Supervisor / IRQ λ“±) ν‘μ‹ |
| **OS μ»¤λ„μ ν•Έλ“¤λ¬**       | `_sys_call_handler`, `_irq_handler` λ“±      |
| **MMU μ„¤μ •**               | νμ΄μ§€ ν…μ΄λΈ” μ£Όμ† μ§€μ •, μΊμ‹ μ •μ±… μ„¤μ •     |

### π“ μ”μ•½ μ •λ¦¬

| ν•­λ©                | μ„¤λ…                                       |
| ------------------- | ------------------------------------------ |
| **CPU μ—­ν• **        | λ…λ Ήμ–΄ μ‹¤ν–‰, μΈν„°λ½νΈ κ°μ§€, λ¨λ“ μ „ν™ μν–‰ |
| **OS μ—­ν• **         | μμ› κ΄€λ¦¬, μ¤μΌ€μ¤„λ§, μ‹μ¤ν… μ½ μ²λ¦¬        |
| **μƒνΈμ‘μ©**        | μ‹μ¤ν… μ½, μΈν„°λ½νΈ, MMU μ μ–΄              |
| **λ³΄νΈ κΈ°λ²•**       | νΉκ¶ λ¨λ“, MMU, μΈν„°λ½νΈ λ§μ¤ν‚Ή            |
| **ν•λ“μ›¨μ–΄ μ¶”μƒν™”** | HALμ„ ν†µν•΄ λ‹¤μ–‘ν• CPUλ¥Ό OSκ°€ λ™μΌν•κ² λ‹¤λ£Έ |

## 11.2 μ‹μ¤ν… μ½ λ° νΈλ© μ²λ¦¬

> μ‚¬μ©μ κ³µκ°„μ—μ„ μ»¤λ„ κ³µκ°„μΌλ΅μ β€μ•μ „ν• λ¬Έβ€™

### π§  μ‹μ¤ν… μ½(System Call)μ΄λ€?

**μ‹μ¤ν… μ½**μ€ μ‚¬μ©μ ν”„λ΅κ·Έλ¨μ΄ μ΄μμ²΄μ μ κΈ°λ¥(νμΌ μ—΄κΈ°, λ©”λ¨λ¦¬ ν• λ‹Ή λ“±)μ„ μ”μ²­ν•λ” **μ μΌν• μΈν„°νμ΄μ¤**μ•Ό.

> μ‚¬μ©μ μ• ν”λ¦¬μΌ€μ΄μ…μ€ μ§μ ‘ ν•λ“μ›¨μ–΄ μ μ–΄λ‚ μ»¤λ„ μμ›μ— μ ‘κ·Όν•  μ μ—†κΈ° λ•λ¬Έμ—,
>  λ°λ“μ‹ μ‹μ¤ν… μ½μ„ ν†µν•΄ **CPU λ¨λ“λ¥Ό μ „ν™**ν•κ³  **OS μ»¤λ„ μ½”λ“λ΅ μ§„μ…**ν•΄μ•Ό ν•΄.

### π› οΈ νΈλ©(Trap)μ΄λ€?

**νΈλ©(Trap)**μ€ CPUκ°€ κ°μ§€ν•λ” **μ†ν”„νΈμ›¨μ–΄μ  μμ™Έ λλ” μ΄λ²¤νΈ**λ΅,
 μ΄μμ²΄μ μ—κ² μ μ–΄κ¶μ„ λ„κ²¨μ£Όλ” λ©”μ»¤λ‹μ¦μ΄μ•Ό.

> νΈλ©μ€ μΌλ°μ μΌλ΅ **μ‹μ¤ν… μ½ μ‹¤ν–‰, μμ™Έ μ²λ¦¬(0μΌλ΅ λ‚λ„κΈ° λ“±)** μ‹ λ°μƒ
>  β†’ ν•λ“μ›¨μ–΄μ μΌλ΅λ” **μΈν„°λ½νΈμ™€ μ μ‚¬**ν•μ§€λ§ μ†ν”„νΈμ›¨μ–΄ κΈ°μ›μ΄ λ§μ

### π”„ μ‹μ¤ν… μ½ μ²λ¦¬ μ „μ²΄ νλ¦„

```
[μ‚¬μ©μ ν”„λ΅κ·Έλ¨]
    β†“ μ‹μ¤ν… μ½ νΈμ¶ (μ: write())
[λΌμ΄λΈλ¬λ¦¬] β†’ `int 0x80`, `ecall`, `svc`
    β†“ Trap λ°μƒ β†’ λ¨λ“ μ „ν™ (User β†’ Kernel)
[OS μ»¤λ„ μ§„μ…] β†’ νΈλ© λ²΅ν„° β†’ ν•Έλ“¤λ¬ νΈμ¶
    β†“ μ‹μ¤ν… μ½ μ²λ¦¬ (νμΌ μ—΄κΈ°, μ½κΈ° λ“±)
    β†“ κ²°κ³Ό μ„¤μ •
[λ¦¬ν„΄ β†’ λ¨λ“ λ³µκ·€ (Kernel β†’ User)]
    β†“ μ‚¬μ©μ ν”„λ΅κ·Έλ¨μΌλ΅ λ³µκ·€
```

### π§© μ£Όμ” κµ¬μ„± μ”μ†

| μ»΄ν¬λ„νΈ                 | μ—­ν•                                        |
| ------------------------ | ------------------------------------------ |
| **Trap λ…λ Ήμ–΄**          | μ‚¬μ©μ β†’ μ»¤λ„ μ§„μ… (`int`, `ecall`, `svc`) |
| **Trap λ²΅ν„°(μμ™Έ λ²΅ν„°)** | κ° νΈλ© λ²νΈμ— λ”°λΌ νΈμ¶λ  ν•¨μ μ£Όμ†       |
| **μ»¤λ„ λ¨λ“ μ¤νƒ**       | μ»¤λ„ μ§„μ… μ‹ μ‚¬μ©ν•  μ•μ „ν• μ¤νƒ            |
| **μ‹μ¤ν… μ½ λ²νΈ**       | μ–΄λ–¤ μ‹μ¤ν… μ½μ„ μ”μ²­ν–λ”μ§€ μ‹λ³„           |
| **λ μ§€μ¤ν„°/λ©”λ¨λ¦¬**      | μΈμ μ „λ‹¬ λ° κ²°κ³Ό λ°ν™                     |

### π“¦ ν”λ«νΌλ³„ μ‹μ¤ν… μ½ νΈλ© λ…λ Ή

| μ•„ν‚¤ν…μ²        | νΈλ© λ…λ Ή  | λ²νΈ λ μ§€μ¤ν„° | μΈμ μ „λ‹¬ λ°©μ‹           |
| --------------- | ---------- | ------------- | ------------------------ |
| **x86 (32bit)** | `int 0x80` | `eax`         | `ebx`, `ecx`, `edx`, ... |
| **x86 (64bit)** | `syscall`  | `rax`         | `rdi`, `rsi`, `rdx`, ... |
| **ARM**         | `svc #0`   | `r7`          | `r0`, `r1`, ...          |
| **RISC-V**      | `ecall`    | `a7`          | `a0`, `a1`, ...          |

### π” μ‹μ¤ν… μ½ λ²νΈ λ° μΈμ μ²λ¦¬ μ (x86 μμ‹)

```
; write(fd, buf, len)
mov eax, 4      ; μ‹μ¤ν… μ½ λ²νΈ (4 = write)
mov ebx, 1      ; fd = stdout
mov ecx, msg    ; λ²„νΌ μ£Όμ†
mov edx, 13     ; κΈΈμ΄
int 0x80        ; νΈλ© νΈμ¶
```

β†’ μ»¤λ„μ€ `eax`μ κ°’μ„ λ³΄κ³  ν•΄λ‹Ή syscall tableμ—μ„ `sys_write()` ν•¨μλ¥Ό νΈμ¶ν•¨

### π§  νΈλ©κ³Ό μΈν„°λ½νΈμ μ°¨μ΄

| κµ¬λ¶„        | νΈλ© (Trap)                    | μΈν„°λ½νΈ (Interrupt)   |
| ----------- | ------------------------------ | ---------------------- |
| λ°μƒ μ›μΈ   | μ†ν”„νΈμ›¨μ–΄ λ…λ Ή / μμ™Έ         | ν•λ“μ›¨μ–΄               |
| μμ‹        | `int`, `ecall`, divide-by-zero | νƒ€μ΄λ¨Έ, ν‚¤λ³΄λ“, λ””μ¤ν¬ |
| λ°μƒ μ‹μ    | λ…λ Ήμ–΄ μ‹¤ν–‰ μ¤‘                 | λ…λ Ήμ–΄ μ‚¬μ΄            |
| μ μ–΄κ¶ μ΄λ™ | μ¦‰μ‹ μ»¤λ„λ΅                    | μ¦‰μ‹ μ»¤λ„λ΅            |
| λ©μ         | OS κΈ°λ¥ νΈμ¶, μμ™Έ μ²λ¦¬        | μ¥μΉ μ‘λ‹µ, μ‹λ¶„ν•       |

### π” μ»¤λ„ μ§„μ… μ‹ μ²λ¦¬ νλ¦„ (μƒμ„Έ)

1. ν„μ¬ **μ‚¬μ©μ λ¨λ“ μƒνƒ μ €μ¥**
   - PC, μ¤νƒ ν¬μΈν„°, ν”λκ·Έ λ μ§€μ¤ν„°, λ μ§€μ¤ν„° λ“±
2. **λ¨λ“ μ „ν™** (User β†’ Kernel)
3. μ»¤λ„ μ¤νƒμΌλ΅ μ¤μ„μΉ­
4. μ‹μ¤ν… μ½ λ²νΈλ¥Ό κΈ°μ¤€μΌλ΅ ν•Έλ“¤λ¬ ν…μ΄λΈ” μ°Έμ΅°
5. μ‹μ¤ν… μ½ μ‹¤ν–‰
6. κ²°κ³Όκ°’μ„ μ‚¬μ©μ μμ—­ λ μ§€μ¤ν„°μ— μ €μ¥
7. **λ¨λ“ λ³µκ·€** ν›„ μ‚¬μ©μ ν”„λ΅κ·Έλ¨μΌλ΅ λ³µκ·€

### π§¬ μ»¤λ„ λ‚΄ μ‹μ¤ν… μ½ ν•Έλ“¤λ¬ κµ¬μ΅° (λ¦¬λ…μ¤ μ)

```
asmlinkage long sys_write(unsigned int fd, const char __user *buf, size_t count) {
    // μ ν¨μ„± κ²€μ‚¬
    // μ»¤λ„ λ²„νΌ λ³µμ‚¬
    // μ‹¤μ  νμΌ λ””λ°”μ΄μ¤μ— μ“°κΈ°
    // κ²°κ³Ό λ°ν™
}
```

β†’ syscall λ²νΈλ” `sys_call_table[]` λ°°μ—΄λ΅ μ—°κ²°λμ–΄ μμ

### π“ μ”μ•½ μ •λ¦¬

| ν•­λ©              | μ„¤λ…                                                    |
| ----------------- | ------------------------------------------------------- |
| **μ‹μ¤ν… μ½**     | μ‚¬μ©μ ν”„λ΅κ·Έλ¨μ΄ OS κΈ°λ¥μ„ μ”μ²­ν•λ” μ•μ „ν• μΈν„°νμ΄μ¤  |
| **νΈλ©(Trap)**    | CPUκ°€ μ»¤λ„μ—κ² μ μ–΄λ¥Ό λ„κΈ°κΈ° μ„ν• μ΄λ²¤νΈ                |
| **λ¨λ“ μ „ν™**     | νΈλ© λ°μƒ μ‹ CPUκ°€ User β†’ Kernel λ¨λ“λ΅ λ³€κ²½            |
| **μ²λ¦¬ νλ¦„**     | νΈλ© λ…λ Ή β†’ ν•Έλ“¤λ¬ β†’ μ‘μ—… μ²λ¦¬ β†’ λ³µκ·€                   |
| **μ•„ν‚¤ν…μ² κµ¬ν„** | `int`, `ecall`, `svc` λ…λ ΉμΌλ΅ νΈλ© κµ¬ν„                |
| **OS λ‚΄ μ²λ¦¬**    | μ‹μ¤ν… μ½ λ²νΈ κΈ°λ°μΌλ΅ ν•¨μ λ””μ¤ν¨μΉ ν›„ μ²λ¦¬ κ²°κ³Ό λ°ν™ |

## 11.3 μ»¨ν…μ¤νΈ μ¤μ„μΉ­

> ν”„λ΅μ„Έμ„μ ν„μ¬ μ‚¬μ©μλ¥Ό λ‹¤λ¥Έ μ‘μ—…μΌλ΅ β€μ „ν™β€™ν•λ” λ©”μ»¤λ‹μ¦

### π§  μ»¨ν…μ¤νΈλ€?

**μ»¨ν…μ¤νΈ(Context)**λ” **ν”„λ΅μ„Έμ¤ λλ” μ¤λ λ“μ μ‹¤ν–‰ μƒνƒλ¥Ό κµ¬μ„±ν•λ” μ •λ³΄ μ§‘ν•©**μ΄μ•Ό.
 CPUλ” μ¤μ§ ν•λ‚μ λ…λ Ήμ–΄ νλ¦„λ§μ„ μ‹¤ν–‰ν•  μ μκΈ° λ•λ¬Έμ—,
 λ‹¤λ¥Έ μ‘μ—…μΌλ΅ μ „ν™ν•  λ•λ” **μ΄μ „ μ‘μ—…μ μ»¨ν…μ¤νΈλ¥Ό μ €μ¥ν•κ³  μƒλ΅μ΄ μ»¨ν…μ¤νΈλ¥Ό λ³µμ›**ν•΄μ•Ό ν•΄.

### π“¦ μ»¨ν…μ¤νΈμ κµ¬μ„± μ”μ†

| κµ¬μ„± μ”μ†                              | μ„¤λ…                                       |
| -------------------------------------- | ------------------------------------------ |
| **μΌλ° λ μ§€μ¤ν„°**                      | R0~~Rn, x86μ EAX~~EDI λ“±                  |
| **μ¤νƒ ν¬μΈν„° (SP)**                   | ν„μ¬ ν•¨μ νΈμ¶μ μ¤νƒ μ„μΉ                 |
| **ν”„λ΅κ·Έλ¨ μΉ΄μ΄ν„° (PC)**               | λ‹¤μμ— μ‹¤ν–‰λ  λ…λ Ήμ–΄μ μ£Όμ†                |
| **ν”„λ΅μ„Έμ„ μƒνƒ λ μ§€μ¤ν„° (PSR/FLAGS)** | λ¨λ“, μΈν„°λ½νΈ μƒνƒ λ“±                     |
| **λ©”λ¨λ¦¬ λ§¤ν•‘ μ •λ³΄**                   | νμ΄μ§€ ν…μ΄λΈ” μ£Όμ†, MMU μ„¤μ •               |
| **μ½”μ–΄λ³„ νΉμ λ μ§€μ¤ν„°**               | x86μ cr3 (νμ΄μ§€ λ””λ ‰ν† λ¦¬), ARMμ SPSR λ“± |

> μ΄ μ •λ³΄κ°€ μ €μ¥λμ–΄μ•Ό ν”„λ΅μ„Έμ¤κ°€ **μ¤‘λ‹¨λ μ§€μ λ¶€ν„° μ •ν™•ν μ¬κ°**λ  μ μμ–΄.

### π”„ μ»¨ν…μ¤νΈ μ¤μ„μΉ­μ λ°μƒ μ‹μ 

| μ‹μ                 | μ„¤λ…                                        |
| ------------------- | ------------------------------------------- |
| **νƒ€μ΄λ¨Έ μΈν„°λ½νΈ** | μ‹λ¶„ν•  μ¤μΌ€μ¤„λ§μ—μ„ μ£ΌκΈ°μ μΌλ΅ λ°μƒ         |
| **μ‹μ¤ν… μ½**       | `sleep()`, `yield()` λ“±μ—μ„ μ¤μ¤λ΅ CPU λ°λ‚© |
| **I/O λ€κΈ°**        | λΈ”λ΅ν‚Ή νΈμ¶ β†’ λ‹¤λ¥Έ ν”„λ΅μ„Έμ¤λ΅ μ „ν™ ν•„μ”     |
| **μ°μ„ μμ„ μ„ μ **   | λ†’μ€ μ°μ„ μμ„μ ν”„λ΅μ„Έμ¤κ°€ μ¤€λΉ„λμ—μ„ λ•    |

### π” μ»¨ν…μ¤νΈ μ¤μ„μΉ­ μ „μ²΄ νλ¦„

```
[1] νƒ€μ΄λ¨Έ μΈν„°λ½νΈ or μ΄λ²¤νΈ λ°μƒ
 β†“
[2] μ»¤λ„ μ§„μ… (trap)
 β†“
[3] ν„μ¬ ν”„λ΅μ„Έμ¤ μƒνƒ μ €μ¥ (λ μ§€μ¤ν„°, PC, SP λ“±)
 β†“
[4] μ¤μΌ€μ¤„λ¬κ°€ λ‹¤μ ν”„λ΅μ„Έμ¤ κ²°μ •
 β†“
[5] μ„ νƒλ ν”„λ΅μ„Έμ¤μ μƒνƒ λ³µμ›
 β†“
[6] μ‚¬μ©μ λ¨λ“ λ³µκ·€
```

### π§ μ‹¤μ  μ»¨ν…μ¤νΈ μ €μ¥ λ°©μ‹ (μ: x86, ARM)

#### β… x86 μ‹μ¤ν… μμ‹

- μ €μ¥ λ€μƒ: `EAX`, `EBX`, ..., `ESP`, `EIP`, `EFLAGS`
- μ „μ© κµ¬μ΅°μ²΄ `struct pt_regs` μ‚¬μ©
- `switch_to(prev, next)` ν•¨μλ΅ μ»¤λ„ μ¤νƒμ„ μ΄λ™
- `iret` λ…λ Ήμ–΄λ΅ μ μ € λ¨λ“ λ³µκ·€

#### β… ARM Cortex-A μμ‹

- `R0~R12`, `LR`, `PC`, `SPSR` λ“± μ €μ¥
- μ»¨ν…μ¤νΈλ” μ»¤λ„ μ¤νƒμ— ν‘Έμ‹λ¨
- λ¨λ“ μ „ν™μ„ μ„ν•΄ `SVC` β†’ `Handler`λ΅ μ§„μ…
- λ³µκ·€ μ‹ `MOVS PC, LR`λ΅ μ΄μ „ μƒνƒ λ³µμ›

### π§© Linux μ»¤λ„ μμ‹ (ARM κΈ°μ¤€)

```
asmlinkage void __switch_to(struct task_struct *prev, struct task_struct *next)
{
    // prevμ μ»¤λ„ μ¤νƒμ—μ„ μ»¨ν…μ¤νΈ μ €μ¥
    // nextμ μ»¤λ„ μ¤νƒμΌλ΅ μ΄λ™
    // λ μ§€μ¤ν„° λ³µμ›
}
```

β†’ `task_struct` λ‚΄λ¶€μ—λ” `thread_struct`κ°€ ν¬ν•¨λμ–΄ μμΌλ©°,
 β†’ μ—¬κΈ°μ— SP, PC, FP λ“±μ **ν•λ“μ›¨μ–΄ μ»¨ν…μ¤νΈ**κ°€ λ“¤μ–΄μμ.

### β±οΈ μ»¨ν…μ¤νΈ μ¤μ„μΉ­μ λΉ„μ©

| μμ›                  | μν–¥                                               |
| --------------------- | -------------------------------------------------- |
| **μ‹κ°„**              | μλ°± ~ μμ² μ‚¬μ΄ν΄ μ†λ¨ (νΉν μΊμ‹ λ¬΄ν¨ν™” λ°μƒ μ‹) |
| **μΊμ‹ μν–¥**         | μƒ ν”„λ΅μ„Έμ¤λ” κΈ°μ΅΄ μΊμ‹λ¥Ό κ±°μ μ‚¬μ© λ»ν•¨           |
| **TLB μν–¥**          | μ£Όμ† κ³µκ°„ μ „ν™ μ‹ TLB ν”λ¬μ‹ λ°μƒ κ°€λ¥             |
| **νμ΄ν”„λΌμΈ ν”λ¬μ‹** | μ‹¤ν–‰ μ¤‘ λ…λ Ήμ–΄ μ·¨μ† ν›„ μƒ λ…λ Ήμ–΄ λ΅λ”© ν•„μ”         |

> κ·Έλμ„ "μ¤λ λ“ κ°„ μ»¨ν…μ¤νΈ μ¤μ„μΉ­ λΉ„μ©μ΄ ν”„λ΅μ„Έμ¤λ³΄λ‹¤ λ‚®λ‹¤"λ” κ²ƒλ„ λ§μ (μ£Όμ† κ³µκ°„μ΄ κ°™μΌλ©΄ TLB ν”λ¬μ‹ μ—†μ)

### π’΅ μµμ ν™” μ „λµ

| κΈ°λ²•                   | μ„¤λ…                                     |
| ---------------------- | ---------------------------------------- |
| **Lazy Switching**     | FPU, SIMD λ μ§€μ¤ν„°λ” ν•„μ”ν•  λ•λ§ μ €μ¥    |
| **TLB Shootdown λ°©μ§€** | SMP ν™κ²½μ—μ„ λ¶ν•„μ”ν• TLB flush μ¤„μ΄κΈ°   |
| **Core Affinity μ μ§€** | ν”„λ΅μ„Έμ¤κ°€ ν•­μƒ κ°™μ€ μ½”μ–΄μ—μ„ μ‹¤ν–‰λλ„λ΅ |
| **μ»¤λ„ μ¤νƒ κ³µμ **     | μ μ‚¬ν• μ»¤λ„ νƒμ¤ν¬λ“¤ κ°„ κ³µμ  μ¤νƒ μ¬ν™μ© |

### π“ μ”μ•½ μ •λ¦¬

| ν•­λ©            | μ„¤λ…                                  |
| --------------- | ------------------------------------- |
| **μ»¨ν…μ¤νΈ**    | ν”„λ΅μ„Έμ¤ λλ” μ¤λ λ“μ μ‹¤ν–‰ μƒνƒ μ „μ²΄ |
| **μ¤μ„μΉ­ μ΄μ ** | μΈν„°λ½νΈ, I/O, νƒ€μ„μ¬λΌμ΄μ¤ λ§λ£ λ“±   |
| **μ €μ¥ ν•­λ©**   | λ μ§€μ¤ν„°, PC, SP, PSR, MMU μƒνƒ λ“±    |
| **λΉ„μ©**        | μΊμ‹ λ° TLB μν–¥, μ§€μ—° λ°μƒ           |
| **OS λ‚΄ μ²λ¦¬**  | μ €μ¥ β†’ μ¤μΌ€μ¤„ β†’ λ³µμ› νλ¦„             |
| **μµμ ν™” κΈ°λ²•** | Lazy save, μ½”μ–΄ κ³ μ •, TLB κ³µμ  λ“±     |

## 11.4 ν”„λ΅μ„Έμ¤ λ° μ¤λ λ“ κ΄€λ¦¬ κµ¬μ΅°

> μ΄μμ²΄μ μ ν•µμ‹¬ μμ›μΈ "μ‹¤ν–‰ λ‹¨μ„"μ λ‚΄λ¶€ κµ¬μ΅°λ¥Ό ν•΄λ¶€ν•λ‹¤

### π§  ν”„λ΅μ„Έμ¤(Process)λ€?

**ν”„λ΅μ„Έμ¤**λ” **μ‹¤ν–‰ μ¤‘μΈ ν”„λ΅κ·Έλ¨μ μΈμ¤ν„΄μ¤**λ΅,
 λ…λ¦½μ μΈ μ£Όμ† κ³µκ°„, μ½”λ“, λ°μ΄ν„°, μ¤νƒ, μ‹μ¤ν… μμ›μ„ λ³΄μ ν•΄.

| κµ¬μ„± μ”μ†        | μ„¤λ…                        |
| ---------------- | --------------------------- |
| μ½”λ“ μμ—­ (Text) | μ‹¤ν–‰ λ…λ Ήμ–΄ μ €μ¥            |
| λ°μ΄ν„° μμ—­      | μ „μ—­λ³€μ, static λ³€μ λ“±    |
| ν™ (Heap)        | λ™μ  λ©”λ¨λ¦¬ ν• λ‹Ή μμ—­       |
| μ¤νƒ (Stack)     | ν•¨μ νΈμ¶ λ° λ΅μ»¬ λ³€μ μ €μ¥ |
| μ»¤λ„ κµ¬μ΅°μ²΄      | `task_struct` λ“±μ—μ„ κ΄€λ¦¬   |

### π§µ μ¤λ λ“(Thread)λ€?

**μ¤λ λ“**λ” **ν”„λ΅μ„Έμ¤ λ‚΄λ¶€μ μ‹¤ν–‰ νλ¦„ λ‹¨μ„**λ΅,
 μ½”λ“/λ°μ΄ν„°/ν™ μμ—­μ€ **κ³µμ **ν•κ³ ,
 **λ μ§€μ¤ν„°/μ¤νƒ/PC**λ§ λ³„λ„λ΅ κ΄€λ¦¬ν•¨.

> ν•λ‚μ ν”„λ΅μ„Έμ¤ μ•μ— μ—¬λ¬ κ°μ μ¤λ λ“κ°€ **λ™μ‹μ— μ‹¤ν–‰** κ°€λ¥ν•κ³ 
>  λ¨λ“  μ¤λ λ“λ” **κ°™μ€ μ£Όμ† κ³µκ°„μ„ κ³µμ **ν•¨.

### π§© ν”„λ΅μ„Έμ¤ vs μ¤λ λ“ λΉ„κµ

| ν•­λ©            | ν”„λ΅μ„Έμ¤               | μ¤λ λ“                    |
| --------------- | ---------------------- | ------------------------- |
| μ£Όμ† κ³µκ°„       | λ…λ¦½                   | κ³µμ                       |
| μμ› μ†μ        | κ³ μ  (νμΌ, λ©”λ¨λ¦¬ λ“±) | κ³µμ                       |
| μƒμ„± λΉ„μ©       | λ†’μ                   | λ‚®μ                      |
| μ»¨ν…μ¤νΈ μ¤μ„μΉ | λ¬΄κ±°μ›€ (MMU, TLB ν¬ν•¨) | κ°€λ²Όμ›€ (λ μ§€μ¤ν„°, μ¤νƒλ§) |
| μ¶©λ μ„ν—       | μ μ                   | λ†’μ (λ™κΈ°ν™” ν•„μ”)        |

### π“¦ μ΄μμ²΄μ  λ‚΄λ¶€ κµ¬μ΅°μ²΄ (Linux κΈ°μ¤€)

#### β… 1. `task_struct`: ν”„λ΅μ„Έμ¤/μ¤λ λ“ κ΄€λ¦¬μ μ¤‘μ‹¬

```
struct task_struct {
    pid_t pid;
    long state;
    struct mm_struct *mm;         // λ©”λ¨λ¦¬ κ³µκ°„
    struct thread_struct thread;  // ν•λ“μ›¨μ–΄ μ»¨ν…μ¤νΈ
    struct files_struct *files;   // μ—΄λ¦° νμΌ ν…μ΄λΈ”
    struct task_struct *parent;   // λ¶€λ¨ ν”„λ΅μ„Έμ¤
    struct list_head children;    // μμ‹ λ¦¬μ¤νΈ
    ...
};
```

> ν”„λ΅μ„Έμ¤μ™€ μ¤λ λ“λ” **`task_struct`λ¥Ό κ³µμ **ν•λ,
>  μ¤λ λ“λ” **μ£Όμ† κ³µκ°„(mm), νμΌ ν…μ΄λΈ”(files) λ“±μ„ κ³µμ **ν•¨

#### β… 2. `thread_struct`: CPU μ»¨ν…μ¤νΈ μ €μ¥μ©

```
struct thread_struct {
    unsigned long sp;     // μ¤νƒ ν¬μΈν„°
    unsigned long ip;     // λ…λ Ήμ–΄ ν¬μΈν„°
    unsigned long flags;  // μƒνƒ ν”λκ·Έ
    ...
};
```

> μ»¨ν…μ¤νΈ μ¤μ„μΉ­ μ‹ λ μ§€μ¤ν„° λ“±μ ν•λ“μ›¨μ–΄ μ •λ³΄λ¥Ό μ €μ¥ν•λ” κµ¬μ΅°

### π” ν”„λ΅μ„Έμ¤ μƒνƒ μ „μ΄ (5-State Model)

```
     +---------+
     | New     |
     +----+----+
          β†“
     +----+----+
     | Ready   |β†β†β†β†β†β†β†β†β†β†β†β†β†β†β†+
     +----+----+               β†‘
          β†“                    β†‘
     +----+----+      I/O or   β†‘
     | Running | β†’β†’β†’β†’β†’β†’β†’β†’β†’β†’β†’β†’β†’β†’+
     +----+----+  Quantum Expire
          β†“
     +----+----+
     | Waiting |
     +----+----+
          β†“
     +----+-------+
     | Terminated |
     +------------+
```

| μƒνƒ           | μ„¤λ…                            |
| -------------- | ------------------------------- |
| **New**        | μƒμ„± μ¤‘                         |
| **Ready**      | μ‹¤ν–‰ λ€κΈ° μ¤‘ (μ¤μΌ€μ¤„λ¬ ν λ€κΈ°) |
| **Running**    | CPUμ—μ„ μ‹¤ν–‰ μ¤‘                 |
| **Waiting**    | I/O λλ” μ΄λ²¤νΈ λ€κΈ°            |
| **Terminated** | μΆ…λ£λ¨ (exit)                   |

### β™οΈ ν”„λ΅μ„Έμ¤/μ¤λ λ“ μƒμ„± λ°©μ‹

#### β… fork() + exec()

- `fork()` β†’ λ¶€λ¨λ¥Ό λ³µμ ν• μƒλ΅μ΄ ν”„λ΅μ„Έμ¤ μƒμ„± (μ£Όμ† κ³µκ°„ λ³µμ )
- `exec()` β†’ μƒλ΅μ΄ ν”„λ΅κ·Έλ¨μΌλ΅ λ©”λ¨λ¦¬ λ®μ–΄μ“°κΈ°

#### β… clone() / pthread_create()

- `clone()`μ€ νΉμ • μμ›(`CLONE_VM`, `CLONE_FILES`, ...)μ„ κ³µμ ν•  μ μμ
- `pthread_create()`λ” μΌλ°μ μΈ μ‚¬μ©μ μ¤λ λ“ μƒμ„± λ°©μ‹

### π” μ¤μΌ€μ¤„λ¬μ™€μ μ—°κ³„

| ν•­λ©                | μ„¤λ…                                                |
| ------------------- | --------------------------------------------------- |
| **ν”„λ΅μ„Έμ¤ ν**     | Ready μƒνƒμ `task_struct`λ“¤μ΄ μ—°κ²° λ¦¬μ¤νΈλ΅ μ €μ¥λ¨ |
| **μ°μ„ μμ„ κΈ°λ°**   | NICE, CFS(Completely Fair Scheduler) λ“±             |
| **νƒ€μ΄λ¨Έ μΈν„°λ½νΈ** | μ£ΌκΈ°μ μΌλ΅ μ¤μΌ€μ¤„λ¬ νΈμ¶ β†’ μ»¨ν…μ¤νΈ μ¤μ„μΉ­ λ°μƒ     |
| **μμ› λΈ”λ΅ν‚Ή**     | Waiting μƒνƒλ΅ μ „ν™ μ‹ λ‹¤λ¥Έ ν”„λ΅μ„Έμ¤ μ„ νƒ           |

### π“ μ‚¬μ©μ vs μ»¤λ„ μ¤λ λ“

| μ ν•                            | μ„¤λ…                                                         |
| ------------------------------- | ------------------------------------------------------------ |
| **μ‚¬μ©μ μ¤λ λ“ (User Thread)** | POSIX `pthread`, κ²½λ‰, λΉ λ¦„, μ»¤λ„ unaware                    |
| **μ»¤λ„ μ¤λ λ“ (Kernel Thread)** | μ»¤λ„μ΄ μΈμ‹ν•κ³  μ¤μΌ€μ¤„λ§ν•λ” μ¤λ λ“ (`ksoftirqd`, `kworker` λ“±) |
| **Hybrid Model**                | M:N λ¨λΈ (μ: old Solaris)                                   |

### π“ μ”μ•½ μ •λ¦¬

| ν•­λ©              | μ„¤λ…                                             |
| ----------------- | ------------------------------------------------ |
| **ν”„λ΅μ„Έμ¤**      | μμ›(λ©”λ¨λ¦¬, νμΌ λ“±)μ„ λ³΄μ ν• λ…λ¦½ μ‹¤ν–‰ λ‹¨μ„    |
| **μ¤λ λ“**        | ν”„λ΅μ„Έμ¤ λ‚΄λ¶€μ μ‹¤ν–‰ νλ¦„, μ£Όμ† κ³µκ°„ κ³µμ         |
| **task_struct**   | λ¨λ“  μ‹¤ν–‰ λ‹¨μ„λ¥Ό λ‚νƒ€λ‚΄λ” μ»¤λ„ κµ¬μ΅°μ²΄            |
| **thread_struct** | ν•λ“μ›¨μ–΄ μ»¨ν…μ¤νΈ μ €μ¥ κ³µκ°„                      |
| **μƒνƒ μ „μ΄**     | Ready β†” Running β†” Waiting λ“±μΌλ΅ μ΄λ™            |
| **μ¤μΌ€μ¤„λ§ λ€μƒ** | λ€λ¶€λ¶„ task_struct (ν”„λ΅μ„Έμ¤ + μ»¤λ„ μ¤λ λ“ ν¬ν•¨) |

## 11.5 μΈν„°λ½νΈμ™€ μ»¤λ„ μ§„μ…

> ν•λ“μ›¨μ–΄ μ‹ νΈκ°€ μ΄μμ²΄μ λ΅ μ΄μ–΄μ§€λ” μ‹¤μ‹κ°„ κ²½λ΅

### π§  μΈν„°λ½νΈλ€?

**μΈν„°λ½νΈ(Interrupt)**λ”
 CPUκ°€ λ…λ Ήμ–΄ μ‹¤ν–‰ μ¤‘ **μ™Έλ¶€ λλ” λ‚΄λ¶€ μ΄λ²¤νΈμ— μν•΄ νλ¦„μ„ μ¤‘λ‹¨ν•κ³ **
 **νΉμ • λ£¨ν‹΄(Interrupt Handler)μ„ μ‹¤ν–‰ν• λ’¤**
 λ‹¤μ‹ μ›λ μ‘μ—…μΌλ΅ λ³µκ·€ν•λ„λ΅ λ§λ“λ” ν•λ“μ›¨μ–΄ λ©”μ»¤λ‹μ¦μ΄μ•Ό.

### π“¦ μΈν„°λ½νΈμ λ¶„λ¥

| λ¶„λ¥                    | μΆ…λ¥          | μμ‹                                       |
| ----------------------- | ------------- | ------------------------------------------ |
| **ν•λ“μ›¨μ–΄ μΈν„°λ½νΈ**   | μ™Έλ¶€ μ¥μΉ     | ν‚¤λ³΄λ“ μ…λ ¥, λ””μ¤ν¬ μ™„λ£, νƒ€μ΄λ¨Έ           |
| **μ†ν”„νΈμ›¨μ–΄ μΈν„°λ½νΈ** | λ…λ Ήμ–΄λ΅ λ°μƒ | `int 0x80`, `ecall`, `svc` (β†’ μ‹μ¤ν… μ½)   |
| **μμ™Έ(Exception)**     | CPU λ‚΄λ¶€ μ¤λ¥ | Divide-by-zero, Page Fault, Invalid Opcode |

### π”„ μΈν„°λ½νΈ μ²λ¦¬ νλ¦„ (μΌλ° κµ¬μ΅°)

```
[1] ν•λ“μ›¨μ–΄ μ¥μΉ β†’ μΈν„°λ½νΈ μ”μ²­ μ‹ νΈ(IRQ)
 β†“
[2] CPU β†’ ν„μ¬ μ‹¤ν–‰ μ¤‘μΈ λ…λ Ήμ–΄ μ™„λ£ ν›„ μΈν„°λ½νΈ κ°μ§€
 β†“
[3] CPU β†’ ν„μ¬ μ»¨ν…μ¤νΈ μ €μ¥ (PC, PSR, λ μ§€μ¤ν„° λ“±)
 β†“
[4] CPU β†’ μΈν„°λ½νΈ λ²΅ν„° ν…μ΄λΈ” μ°Έμ΅° (ISR μ£Όμ†)
 β†“
[5] ISR μ‹¤ν–‰ β†’ ν•΄λ‹Ή μ΄λ²¤νΈ μ²λ¦¬
 β†“
[6] μ»¨ν…μ¤νΈ λ³µμ› ν›„ μ›λ μ„μΉλ΅ λ³µκ·€ (iret λ“±)
```

### π“ μΈν„°λ½νΈ λ²΅ν„° ν…μ΄λΈ” (IVT)

- **IVT**λ” μΈν„°λ½νΈ λ²νΈμ— λ”°λΌ ISRμ **μ‹μ‘ μ£Όμ†λ¥Ό μ €μ¥ν• ν…μ΄λΈ”**
- CPUκ°€ μΈν„°λ½νΈλ¥Ό λ°›μΌλ©΄ ν•΄λ‹Ή λ²νΈμ— ν•΄λ‹Ήν•λ” **μ—”νΈλ¦¬λ΅ μ ν”„**

| μμ‹ (x86) | μ£Όμ†           | μΈν„°λ½νΈ |
| ---------- | -------------- | -------- |
| `0x00`     | Divide by Zero |          |
| `0x20`     | Timer          |          |
| `0x21`     | Keyboard       |          |
| `0x80`     | System Call    |          |

> ARMκ³Ό RISC-Vλ” κ°κ° **vector base register(VBAR, MTVEC)**λ΅ λ²΅ν„° ν…μ΄λΈ” μ„μΉ μ§€μ •

### π§¬ μ»¤λ„ μ§„μ… μ‹ λ™μ‘

#### μ»¤λ„ μ§„μ…μ€ λ‹¤μ μ΅°κ±΄ μ¤‘ ν•λ‚μΌ λ• λ°μƒ:

- ν•λ“μ›¨μ–΄ μΈν„°λ½νΈ
- μ‹μ¤ν… μ½ (μ†ν”„νΈμ›¨μ–΄ μΈν„°λ½νΈ)
- μμ™Έ (νμ΄μ§€ ν΄νΈ, λ³΄νΈ μ„λ° λ“±)

#### μ΄λ• CPUλ”:

1. ν„μ¬ **λ¨λ“λ¥Ό User β†’ Kernel**λ΅ μ „ν™
2. **μΈν„°λ½νΈ λ²΅ν„°λ¥Ό λ”°λΌ ν•Έλ“¤λ¬λ΅ μ ν”„**
3. **μ»¤λ„ μ¤νƒ μ‚¬μ©** μ‹μ‘
4. ISRμ΄ λλ‚λ©΄ **μ›λ μ»¨ν…μ¤νΈλ΅ λ³µκ·€**

### π”‚ μΈν„°λ½νΈ μ»¨ν…μ¤νΈ vs ν”„λ΅μ„Έμ¤ μ»¨ν…μ¤νΈ

| ν•­λ©               | μΈν„°λ½νΈ μ»¨ν…μ¤νΈ                   | ν”„λ΅μ„Έμ¤ μ»¨ν…μ¤νΈ                  |
| ------------------ | ----------------------------------- | ---------------------------------- |
| μ •μ               | μΈν„°λ½νΈ ν•Έλ“¤λ¬ μ‹¤ν–‰ μ¤‘ μƒνƒ        | μΌλ° μ‚¬μ©μ/μ»¤λ„ λ¨λ“ μ‹¤ν–‰ μ¤‘ μƒνƒ |
| μ¤μΌ€μ¤„λ§           | λ¶κ°€λ¥                              | κ°€λ¥                               |
| μ°¨λ‹¨ κ°€λ¥μ„±        | λΉ„λ™κΈ°, preempt λ¶κ°€                | κ°€λ¥                               |
| μ»¤λ„ API μ‚¬μ© μ ν• | μ ν•λ¨ (`sleep()`, `malloc()` λ¶κ°€) | μμ λ΅μ›€                           |

> μΈν„°λ½νΈ ν•Έλ“¤λ¬λ” λΉ λ¥΄κ² λλ‚μ•Ό ν•λ©°, **μ¬λ¦½ λ¶κ°€, μ¤μΌ€μ¤„ λ¶κ°€, λ³µμ΅ μ—°μ‚° μ ν•**

### π› οΈ μ‹¤μ  κµ¬μ΅° μ: x86 μ•„ν‚¤ν…μ²

1. μΈν„°λ½νΈ λ°μƒ
2. CPUλ” **IDT(Interrupt Descriptor Table)**λ¥Ό μ‚¬μ©ν•΄ ISR μ£Όμ† κ²°μ •
3. ν„μ¬ `EFLAGS`, `CS`, `EIP` μ €μ¥ β†’ μ»¤λ„ μ¤νƒμΌλ΅ μ΄λ™
4. ISR μ‹¤ν–‰
5. λ³µκ·€ μ‹ `iret`λ΅ μ›λ μ„μΉ λ³µμ›

### π› οΈ μ‹¤μ  κµ¬μ΅° μ: ARM μ•„ν‚¤ν…μ²

1. μΈν„°λ½νΈ λ°μƒ μ‹ μλ™μΌλ΅ λ¨λ“ μ „ν™ (IRQ λ¨λ“ λ“±)
2. `SPSR`, `LR_irq`, `SP_irq` μλ™ μ„¤μ •
3. VBAR (Vector Base Address Register) κΈ°μ¤€μΌλ΅ ISR μ§„μ…
4. λ³µκ·€ μ‹ `SUBS PC, LR, #4` λλ” `MOVS PC, LR` μ‚¬μ©

### π’΅ μΈν„°λ½νΈμ μ°μ„ μμ„ λ° λ§μ¤ν‚Ή

| κΈ°λ¥                 | μ„¤λ…                                                    |
| -------------------- | ------------------------------------------------------- |
| **μ°μ„ μμ„**         | μ—¬λ¬ μΈν„°λ½νΈκ°€ λ™μ‹μ— λ°μƒ μ‹ μ²λ¦¬ μμ„ κ²°μ •           |
| **λ§μ¤ν‚Ή (Masking)** | νΉμ • μΈν„°λ½νΈλ¥Ό μΌμ‹μ μΌλ΅ μ°¨λ‹¨ (`cli`, `cpsid i`)      |
| **Nesting μ§€μ›**     | λ†’μ€ μ°μ„ μμ„ μΈν„°λ½νΈκ°€ λ‚®μ€ μΈν„°λ½νΈ ν•Έλ“¤λ¬ μ¤‘λ‹¨ κ°€λ¥ |

### π“ μ”μ•½ μ •λ¦¬

| ν•­λ©                  | μ„¤λ…                                                   |
| --------------------- | ------------------------------------------------------ |
| **μΈν„°λ½νΈ**          | μ™Έλ¶€ μ‹ νΈλ΅ CPU νλ¦„μ„ κ°•μ λ΅ λ³€κ²½ν•λ” μ¥μΉ            |
| **λ²΅ν„° ν…μ΄λΈ”**       | μΈν„°λ½νΈ λ²νΈ β†’ ν•Έλ“¤λ¬ μ£Όμ† μ—°κ²°                       |
| **μ»¤λ„ μ§„μ…**         | μ‚¬μ©μ λ¨λ“μ—μ„ μΈν„°λ½νΈ λ°μƒ μ‹ λ³΄νΈ λ¨λ“ μ „ν™        |
| **μ»¨ν…μ¤νΈ μ €μ¥**     | PC, PSR, λ μ§€μ¤ν„° λ“± μ»¤λ„ μ¤νƒμ— μ €μ¥                  |
| **μΈν„°λ½νΈ μ»¨ν…μ¤νΈ** | μ ν•λ μ‹¤ν–‰ ν™κ²½, λΉ λ¥΄κ² μ²λ¦¬ν•΄μ•Ό ν•¨                   |
| **λ³µκ·€ λ…λ Ήμ–΄**       | x86: `iret`, ARM: `subs pc, lr, #4`, RISC-V: `mret` λ“± |

## 11.6 RTOSμ™€ μΌλ° OSμ μ°¨μ΄

> μ‹¤μ‹κ°„μ„±κ³Ό λ²”μ©μ„± μ‚¬μ΄μ ν•µμ‹¬ κµ¬μ΅°μ  μ°¨μ΄

### π§  κΈ°λ³Έ μ •μ

| κµ¬λ¶„ | RTOS (μ‹¤μ‹κ°„ μ΄μμ²΄μ )                                       | μΌλ° OS (λ²”μ© μ΄μμ²΄μ )                                      |
| ---- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| μ •μ | **μ •ν•΄μ§„ μ‹κ°„ λ‚΄μ— μ‘μ—…μ„ ν™•μ‹¤ν μ™„λ£**ν•  μ μλ„λ΅ λ³΄μ¥ν•λ” μ΄μμ²΄μ  | λ‹¤μ–‘ν• λ©μ μ μ‘μ—…μ„ **μµλ€ν• ν¨μ¨μ μΌλ΅ μ²λ¦¬**ν•λ” μ΄μμ²΄μ  |
| λ©μ  | **μ •ν™•ν• μ‘λ‹µ μ‹κ°„ λ³΄μ¥ (Deadlines)**                        | **μ²λ¦¬λ‰, μ‚¬μ©μ νΈμμ„±, μμ› ν¨μ¨ κ·Ήλ€ν™”**                  |
| μμ‹ | FreeRTOS, VxWorks, ThreadX, RTEMS                            | Linux, Windows, macOS, Android                               |

### β±οΈ μ‹¤μ‹κ°„μ„± (Determinism)

| ν•­λ©          | RTOS                                   | μΌλ° OS                   |
| ------------- | -------------------------------------- | ------------------------- |
| μ‘λ‹µ μ‹κ°„     | μμΈ΅ κ°€λ¥ (μ •ν•΄μ§„ μ‹κ°„ μ•μ— ν•­μƒ λ™μ‘) | λ¶ν™•μ‹¤, μ§€μ—° λ°μƒ κ°€λ¥    |
| μ§€ν„°(Jitter)  | κ±°μ μ—†μ (μΌκ΄€λ μ‘λ‹µ)                | OS μƒνƒ, λ¶€ν•μ— λ”°λΌ λ³€λ™ |
| μΈν„°λ½νΈ μ‘λ‹µ | μ ΞΌs μ΄λ‚΄, μ •λ°€ μ μ–΄ κ°€λ¥             | μ ms μ΄μƒ μ†μ”λ  μ μμ |
| λ°λ“λΌμΈ λ€μ‘ | ν•λ“/μ†ν”„νΈ μ‹¤μ‹κ°„ λ³΄μ¥                | λ°λ“λΌμΈ λ³΄μ¥ λ¶κ°€λ¥      |

### π”„ μ¤μΌ€μ¤„λ§ λ°©μ‹

| ν•­λ©          | RTOS                                | μΌλ° OS                                                |
| ------------- | ----------------------------------- | ------------------------------------------------------ |
| μ¤μΌ€μ¤„λ§ μ •μ±… | **μ°μ„ μμ„ κΈ°λ°, μ„ μ ν•** μ¤‘μ‹¬      | μ°μ„ μμ„ + **κ³µμ •μ„±(Fairness), μ‹λ¶„ν• ** μ¤‘μ‹¬           |
| μ¤λ λ“ μ„ μ    | κ³ μ°μ„ μμ„ νƒμ¤ν¬ μ¦‰μ‹ μ‹¤ν–‰         | κ³µμ •μ„±μ„ κ³ λ ¤ν•΄ μ ν•λ¨                                 |
| κ³ μ • μ°μ„ μμ„ | κ°€λ¥ (Priority Inversion λ°©μ§€ ν•„μ”) | λ™μ  μ°μ„ μμ„ λλ” CFS(Completely Fair Scheduler) μ‚¬μ© |

### β™οΈ μ»¤λ„ κµ¬μ΅°

| ν•­λ©          | RTOS                            | μΌλ° OS                   |
| ------------- | ------------------------------- | ------------------------- |
| μ»¤λ„ ν¬κΈ°     | μ‘κ³  λ¨λ“ν™”λ¨ (μ KB~μλ°± KB)   | ν¬κ³  λ³µμ΅ (μ MB μ΄μƒ)    |
| κµ¬μ΅°          | λ¨λ†€λ¦¬μ‹ λλ” λ§μ΄ν¬λ΅μ»¤λ„ κΈ°λ° | λ€λ¶€λ¶„ λ¨λ†€λ¦¬μ‹ μ»¤λ„      |
| μ „ν™ μ†λ„     | λΉ λ¦„ (ΞΌs λ‹¨μ„)                  | μƒλ€μ μΌλ΅ λλ¦Ό (ms λ‹¨μ„) |
| ν•λ“μ›¨μ–΄ μ μ–΄ | μ§μ ‘ μ μ–΄ μ¤‘μ‹¬                  | λ“λΌμ΄λ²„ κ³„μΈµν™” ν›„ μ²λ¦¬   |

### π§  λ©”λ¨λ¦¬ λ° μμ› κ΄€λ¦¬

| ν•­λ©        | RTOS                     | μΌλ° OS                       |
| ----------- | ------------------------ | ----------------------------- |
| λ©”λ¨λ¦¬ κ΄€λ¦¬ | μΌλ°μ μΌλ΅ **μ •μ  ν• λ‹Ή** | λ™μ  λ©”λ¨λ¦¬ κ΄€λ¦¬ μ§€μ›         |
| MMU         | λ€λ¶€λ¶„ μ—†μ / μ ν•μ      | μ „μ²΄ κ°€μƒ λ©”λ¨λ¦¬ μ§€μ›         |
| λ©€ν‹°νƒμ¤ν‚Ή  | κΈ°λ³Έ μ§€μ›, λ‹¨μν• κµ¬μ΅°   | λ³µμ΅ν• μ»¨ν…μ¤νΈ μ¤μ„μΉ­ ν¬ν•¨   |
| νμΌ μ‹μ¤ν… | κ²½λ‰ λλ” μ—†μ           | μ™„μ „ν• POSIX νμΌ μ‹μ¤ν… μ κ³µ |

### π” μ°μ„ μμ„ μ—­μ „ (Priority Inversion) λ€μ‘

RTOSλ” λ†’μ€ μ°μ„ μμ„ μ‘μ—…μ΄ **λ‚®μ€ μ°μ„ μμ„ μ‘μ—… λ•λ¬Έμ— μ§€μ—°λμ§€ μ•λ„λ΅**
 `Priority Inheritance`, `Priority Ceiling Protocol` λ“±μ λ©”μ»¤λ‹μ¦μ„ λ°λ“μ‹ ν¬ν•¨ν•΄μ•Ό ν•¨.

### π“¦ μ‘μ© λ¶„μ•Ό μ°¨μ΄

| RTOS                       | μΌλ° OS                             |
| -------------------------- | ----------------------------------- |
| μ„λ² λ””λ“ μ‹μ¤ν…            | λ°μ¤ν¬νƒ‘ / μ„λ²„                     |
| ν•­κ³µμ°μ£Ό, μλ£κΈ°κΈ°, μλ™μ°¨ | κ²μ„, μ›Ή λΈλΌμ°μ§•, λ©€ν‹°λ―Έλ””μ–΄       |
| λ΅λ΄‡ μ μ–΄, PLC, IoT        | λ°μ΄ν„° μ²λ¦¬, κ°€μƒν™”, μ‚¬μ©μ μ•± μ‹¤ν–‰ |
| ν•λ“ μ‹¤μ‹κ°„ ν•„μ           | μ‹¤μ‹κ°„μ„±μ€ μµμ…                     |

### π› οΈ λ€ν‘ RTOS vs μΌλ° OS λΉ„κµ

| ν•­λ©          | FreeRTOS (RTOS)       | Linux (GPOS)                       |
| ------------- | --------------------- | ---------------------------------- |
| μ»¤λ„ ν¬κΈ°     | μμ‹­ KB               | μ MB                              |
| μ¤μΌ€μ¤„λ§      | μ°μ„ μμ„ κΈ°λ°, μ„ μ ν• | κ³µμ • μ¤μΌ€μ¤„λ§(CFS), time-slice     |
| μ‘λ‹µ μ‹κ°„     | μ ΞΌs                 | μ ms                              |
| API           | μ ν•μ  (POSIX μΌλ¶€)   | POSIX μ „μ²΄, λ‹¤μ–‘ν• μ‹μ¤ν… μ½       |
| MMU           | ν•„μ” μ—†μ             | ν•„μ                               |
| νμΌ μ‹μ¤ν…   | μ—†μ / κ°„λ‹¨ν• FAT     | ext4, Btrfs λ“± μ™„μ „ν• FS           |
| μΈν„°λ½νΈ μ²λ¦¬ | μ§μ ‘ ν•Έλ“¤λ¬ λ“±λ΅      | `request_irq()` β†’ IRQ handler λ¶„κΈ° |

### π§© μ‹¤μ‹κ°„μ„±μ΄ μ¤‘μ”ν• λ¶„μ•Όμ—μ„ RTOSκ°€ ν•„μ”ν• μ΄μ 

| λ¶„μ•Ό                 | μ‹¤μ‹κ°„ μ”κµ¬ μ΄μ                           |
| -------------------- | ----------------------------------------- |
| **ν•­κ³µ μ μ–΄ μ‹μ¤ν…** | μ…λ ¥ ν›„ λ‡ ΞΌs λ‚΄ λ°μ‘ ν•„μ”                |
| **μλ™μ°¨ ECU**       | ABS, μ—μ–΄λ°± λ“± λ§μ΄ν¬λ΅μ΄ λ‹¨μ„ νλ‹¨       |
| **λ΅λ΄‡ μ μ–΄κΈ°**      | μ„Όμ„ β†’ κ³„μ‚° β†’ λ¨ν„° μ μ–΄κΉμ§€ λ”λ μ΄ μµμ†ν™” |
| **μλ£κΈ°κΈ°**         | μ‹¤μ‹κ°„ μƒμ²΄μ‹ νΈ μ²λ¦¬ ν•„μ                 |
| **μ‚°μ—…μ© μ¥λΉ„**      | νƒ€μ΄λ° λ³΄μ¥ μ—†λ” μ‹μ¤ν…μ€ μ‚¬μ© λ¶κ°€       |

### π“ μ”μ•½ μ •λ¦¬

| ν•­λ©          | RTOS                     | μΌλ° OS                  |
| ------------- | ------------------------ | ------------------------ |
| **μ‹¤μ‹κ°„μ„±**  | μ •λ°€ μ μ–΄, μμΈ΅ κ°€λ¥     | λ¶ν™•μ‹¤, λΉ„μ‹¤μ‹κ°„         |
| **μ¤μΌ€μ¤„λ§**  | μ°μ„ μμ„ κΈ°λ°, λΉ λ¥Έ μ„ μ  | κ³µμ •μ„± κΈ°λ°, μƒλ€μ  μ§€μ—° |
| **μ»¤λ„ κµ¬μ΅°** | μ‘κ³  λ‹¨μ                | λ³µμ΅ν•κ³  ν™•μ¥ κ°€λ¥       |
| **μμ› κ΄€λ¦¬** | μ •μ , κ²½λ‰               | λ™μ , μ μ—°               |
| **μ‘μ© λ¶„μ•Ό** | μ„λ² λ””λ“, μ μ–΄κΈ°         | λ²”μ© μ»΄ν“¨ν…, μ‚¬μ©μ μ•±   |
| **λ³΄μ¥μ„±**    | λ°λ“λΌμΈ μ¤‘μ‹¬            | Throughput μ¤‘μ‹¬          |

